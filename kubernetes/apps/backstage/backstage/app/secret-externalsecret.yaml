apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: backstage-secrets
  namespace: backstage
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault
  target:
    name: backstage-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      type: Opaque
      data:
        # Non-secret but kept here to keep Backstage config uniform.
        POSTGRES_DB: '{{ .POSTGRES_DB | default "backstage" }}'

        # Required secrets (stored in Vault).
        GITHUB_TOKEN: "{{ .GITHUB_TOKEN }}"
        AUTH_GITHUB_CLIENT_ID: "{{ .AUTH_GITHUB_CLIENT_ID }}"
        AUTH_GITHUB_CLIENT_SECRET: "{{ .AUTH_GITHUB_CLIENT_SECRET }}"
        GA_MEASUREMENT_ID: "{{ .GA_MEASUREMENT_ID }}"
        OPENAPI_AI_KEY: "{{ .OPENAPI_AI_KEY }}"

        GITHUB_APP_ID: "{{ .GITHUB_APP_ID }}"
        GITHUB_APP_CLIENT_ID: "{{ .GITHUB_APP_CLIENT_ID }}"
        GITHUB_APP_CLIENT_SECRET: "{{ .GITHUB_APP_CLIENT_SECRET }}"
        GITHUB_APP_WEBHOOK_SECRET: "{{ .GITHUB_APP_WEBHOOK_SECRET }}"
        GITHUB_APP_PRIVATE_KEY: "{{ .GITHUB_APP_PRIVATE_KEY }}"

        # Optional settings (default empty if not present in Vault).
        SENTRY_TOKEN: '{{ .SENTRY_TOKEN | default "" }}'
        NEW_RELIC_REST_API_KEY: '{{ .NEW_RELIC_REST_API_KEY | default "" }}'
        NEW_RELIC_USER_KEY: '{{ .NEW_RELIC_USER_KEY | default "" }}'
        K8S_SERVICE_ACCOUNT_TOKEN_BACKSTAGE: '{{ .K8S_SERVICE_ACCOUNT_TOKEN_BACKSTAGE | default "" }}'
        K8S_CONFIG_CA_DATA: '{{ .K8S_CONFIG_CA_DATA | default "" }}'

        BACKEND_SECRET: "{{ .BACKEND_SECRET }}"
  dataFrom:
    - extract:
      key: ${VAULT_ORG}/${VAULT_ENV}/clusters/${VAULT_CLUSTER}/apps/backstage/app
