---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: renovate-job-cleanup
  namespace: renovate

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: renovate-job-cleanup
  namespace: renovate
rules:
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["get", "list", "delete"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: renovate-job-cleanup
  namespace: renovate
subjects:
  - kind: ServiceAccount
    name: renovate-job-cleanup
    namespace: renovate
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: renovate-job-cleanup

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: renovate-job-cleanup
  namespace: renovate
spec:
  schedule: "35 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          serviceAccountName: renovate-job-cleanup
          restartPolicy: Never
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            runAsGroup: 65534
          containers:
            - name: cleanup
              image: docker.io/bitnami/kubectl:1.30
              imagePullPolicy: IfNotPresent
              env:
                - name: HOME
                  value: /tmp
              command:
                - /bin/sh
                - -ceu
                - |
                  namespace="renovate"
                  ttl_days="3"
                  cutoff_epoch="$(date -u -d "-${ttl_days} days" +%s)"

                  kubectl get jobs -n "$namespace" -o go-template='{{range .items}}{{.metadata.name}} {{.metadata.creationTimestamp}} {{if .status.active}}{{.status.active}}{{else}}0{{end}}{{"\n"}}{{end}}' |
                    while read -r job_name created_ts active; do
                      [ -n "$job_name" ] || continue
                      [ "$active" = "0" ] || continue
                      created_epoch="$(date -u -d "$created_ts" +%s)"
                      [ "$created_epoch" -le "$cutoff_epoch" ] || continue
                      kubectl delete job -n "$namespace" "$job_name" --ignore-not-found=true
                    done
              securityContext:
                allowPrivilegeEscalation: false
                runAsNonRoot: true
                readOnlyRootFilesystem: true
                capabilities:
                  drop: ["ALL"]
              resources:
                requests:
                  cpu: 10m
                  memory: 64Mi
                limits:
                  memory: 128Mi
              volumeMounts:
                - name: tmp
                  mountPath: /tmp

          volumes:
            - name: tmp
              emptyDir: {}
