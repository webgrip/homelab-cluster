---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: renovate-github-app-token
  namespace: renovate
spec:
  schedule: "*/15 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        spec:
          serviceAccountName: renovate-github-app-token
          restartPolicy: Never
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            runAsGroup: 65534
          initContainers:
            - name: mint-token
              image: ghcr.io/mshekow/github-app-installation-token:2026.01.15@sha256:cd651456982d34ab9801e24d6ad126df3c22a17bab68713318858e184d6f1130
              imagePullPolicy: IfNotPresent
              envFrom:
                - secretRef:
                    name: renovate-secrets
              env:
                - name: GITHUB_API
                  value: https://api.github.com
              command:
                - /bin/sh
                - -ceu
                - |
                  : "${RENOVATE_GITHUB_APP_ID:?missing RENOVATE_GITHUB_APP_ID}"
                  : "${RENOVATE_GITHUB_APP_INSTALLATION_ID:?missing RENOVATE_GITHUB_APP_INSTALLATION_ID}"

                  if [ ! -s /secrets/private-key.txt ]; then
                    echo "missing private key file (/secrets/private-key.txt)" >&2
                    exit 1
                  fi

                  node index.js \
                    "$RENOVATE_GITHUB_APP_ID" \
                    "$RENOVATE_GITHUB_APP_INSTALLATION_ID" \
                    /secrets/private-key.txt \
                    "$GITHUB_API" \
                    > /work/token

                  if [ ! -s /work/token ]; then
                    echo "failed to mint installation token" >&2
                    exit 1
                  fi
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop: ["ALL"]
              resources:
                requests:
                  cpu: 10m
                  memory: 64Mi
                limits:
                  memory: 256Mi
              volumeMounts:
                - name: work
                  mountPath: /work
                - name: tmp
                  mountPath: /tmp
                - name: github-app-private-key
                  mountPath: /secrets
                  readOnly: true
          containers:
            - name: apply-secret
              image: docker.io/alpine/k8s:1.34.3
              imagePullPolicy: IfNotPresent
              env:
                - name: GITHUB_API
                  value: https://api.github.com
                - name: RUNTIME_SECRET_NAME
                  value: renovate-runtime-token
                - name: RUNTIME_SECRET_KEY
                  value: token
              command:
                - /bin/sh
                - -ceu
                - |
                  token="$(cat /work/token)"

                  kubectl -n renovate create secret generic "$RUNTIME_SECRET_NAME" \
                    --from-literal="$RUNTIME_SECRET_KEY=$token" \
                    --from-literal="RENOVATE_TOKEN=$token" \
                    --dry-run=client \
                    -o yaml \
                    | kubectl apply -f -

              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop: ["ALL"]
              resources:
                requests:
                  cpu: 10m
                  memory: 64Mi
                limits:
                  memory: 256Mi
              volumeMounts:
                - name: work
                  mountPath: /work

          volumes:
            - name: work
              emptyDir: {}
            - name: tmp
              emptyDir: {}
            - name: github-app-private-key
              secret:
                secretName: renovate-secrets
                items:
                  - key: RENOVATE_GITHUB_APP_PRIVATE_KEY
                    path: private-key.txt
