---
apiVersion: v1
kind: ConfigMap
metadata:
  name: freshrss-db-bootstrap
  labels:
    app.kubernetes.io/name: freshrss-db-bootstrap
    app.kubernetes.io/component: database-bootstrap
    app.kubernetes.io/part-of: freshrss
  annotations:
    kustomize.toolkit.fluxcd.io/substitute: disabled
data:
  bootstrap.sh: |-
    #!/bin/bash
    set -euo pipefail

    if [ -d "/opt/bitnami/postgresql/bin" ]; then
      export PATH="/opt/bitnami/postgresql/bin:${PATH}"
    fi

    required_env="POSTGRES_HOST POSTGRES_DB POSTGRES_USER POSTGRES_PASSWORD POSTGRES_SUPERUSER_PASSWORD"
    for var in $required_env; do
      if [ -z "${!var:-}" ]; then
        echo "Missing required environment variable: $var" >&2
        exit 1
      fi
    done

    SUPERUSER="${POSTGRES_SUPERUSER_USER:-postgres}"
    PORT="${POSTGRES_PORT:-5432}"
    SSLMODE="${POSTGRES_SSLMODE:-prefer}"

    export PGHOST="${POSTGRES_HOST}"
    export PGPORT="${PORT}"
    export PGUSER="${SUPERUSER}"
    export PGDATABASE="postgres"
    export PGPASSWORD="${POSTGRES_SUPERUSER_PASSWORD}"
    export PGSSLMODE="${SSLMODE}"

    psql_base="psql -v ON_ERROR_STOP=1"

    echo "Ensuring role ${POSTGRES_USER}"
    cat <<SQL | env role="${POSTGRES_USER}" role_password="${POSTGRES_PASSWORD}" ${psql_base}
    DO
    $$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = :'role') THEN
        EXECUTE format('CREATE ROLE %I LOGIN PASSWORD %L', :'role', :'role_password');
      ELSE
        EXECUTE format('ALTER ROLE %I LOGIN PASSWORD %L', :'role', :'role_password');
      END IF;
    END
    $$ LANGUAGE plpgsql;
    SQL

    echo "Ensuring database ${POSTGRES_DB}"
    cat <<SQL | env db="${POSTGRES_DB}" role="${POSTGRES_USER}" ${psql_base}
    SELECT 'create-db' AS action
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = :'db');
    SQL
    if [ "$(${psql_base} -tAc "SELECT 1 FROM pg_database WHERE datname='${POSTGRES_DB}'")" != "1" ]; then
      echo "Creating database ${POSTGRES_DB}"
      ${psql_base} --command "CREATE DATABASE \"${POSTGRES_DB}\" OWNER \"${POSTGRES_USER}\";"
    else
      echo "Database ${POSTGRES_DB} already exists"
    fi

    echo "Applying database privileges"
    ${psql_base} --command "REVOKE ALL ON DATABASE \"${POSTGRES_DB}\" FROM PUBLIC;"
    ${psql_base} --command "GRANT ALL PRIVILEGES ON DATABASE \"${POSTGRES_DB}\" TO \"${POSTGRES_USER}\";"

    echo "FreshRSS database bootstrap complete"
