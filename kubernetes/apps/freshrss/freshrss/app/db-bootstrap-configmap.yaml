---
apiVersion: v1
kind: ConfigMap
metadata:
  name: freshrss-db-bootstrap
  labels:
    app.kubernetes.io/name: freshrss-db-bootstrap
    app.kubernetes.io/component: database-bootstrap
    app.kubernetes.io/part-of: freshrss
  annotations:
    kustomize.toolkit.fluxcd.io/substitute: disabled
data:
  bootstrap.sh: |-
    #!/bin/bash
    set -euo pipefail

    if [ -d "/opt/bitnami/postgresql/bin" ]; then
      export PATH="/opt/bitnami/postgresql/bin:${PATH}"
    fi

    required_env="POSTGRES_HOST POSTGRES_DB POSTGRES_USER POSTGRES_PASSWORD POSTGRES_SUPERUSER_PASSWORD"
    for var in $required_env; do
      if [ -z "${!var:-}" ]; then
        echo "Missing required environment variable: $var" >&2
        exit 1
      fi
    done

    SUPERUSER="${POSTGRES_SUPERUSER_USER:-postgres}"
    PORT="${POSTGRES_PORT:-5432}"
    SSLMODE="${POSTGRES_SSLMODE:-prefer}"

    export PGHOST="${POSTGRES_HOST}"
    export PGPORT="${PORT}"
    export PGUSER="${SUPERUSER}"
    export PGDATABASE="postgres"
    export PGPASSWORD="${POSTGRES_SUPERUSER_PASSWORD}"
    export PGSSLMODE="${SSLMODE}"

    psql_base="psql -v ON_ERROR_STOP=1"

    echo "Ensuring role ${POSTGRES_USER}"
    $psql_base --command "DO \$\$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '${POSTGRES_USER}') THEN
        EXECUTE format('CREATE ROLE %I LOGIN PASSWORD %L', '${POSTGRES_USER}', '${POSTGRES_PASSWORD}');
      ELSE
        EXECUTE format('ALTER ROLE %I LOGIN PASSWORD %L', '${POSTGRES_USER}', '${POSTGRES_PASSWORD}');
      END IF;
    END
    \$\$ LANGUAGE plpgsql;"

    echo "Ensuring database ${POSTGRES_DB}"
    $psql_base --command "DO \$\$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_database WHERE datname = '${POSTGRES_DB}') THEN
        EXECUTE format('CREATE DATABASE %I OWNER %I', '${POSTGRES_DB}', '${POSTGRES_USER}');
      ELSE
        EXECUTE format('ALTER DATABASE %I OWNER TO %I', '${POSTGRES_DB}', '${POSTGRES_USER}');
      END IF;
    END
    \$\$ LANGUAGE plpgsql;"

    echo "Applying database privileges"
    $psql_base --command "DO \$\$
    BEGIN
      EXECUTE format('REVOKE ALL ON DATABASE %I FROM PUBLIC', '${POSTGRES_DB}');
      EXECUTE format('GRANT ALL PRIVILEGES ON DATABASE %I TO %I', '${POSTGRES_DB}', '${POSTGRES_USER}');
    END
    \$\$ LANGUAGE plpgsql;"

    echo "FreshRSS database bootstrap complete"
