---
apiVersion: batch/v1
kind: Job
metadata:
  name: freshrss-db-bootstrap
  labels:
    app.kubernetes.io/name: freshrss-db-bootstrap
    app.kubernetes.io/component: database-bootstrap
    app.kubernetes.io/part-of: freshrss
spec:
  backoffLimit: 5
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app.kubernetes.io/name: freshrss-db-bootstrap
        app.kubernetes.io/component: database-bootstrap
        app.kubernetes.io/part-of: freshrss
    spec:
      automountServiceAccountToken: false
      restartPolicy: Never
      containers:
        - name: bootstrap
          image: docker.io/bitnami/postgresql-client:17.6.0-debian-12-r4
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
            - -ec
            - /scripts/bootstrap.sh
          env:
            - name: POSTGRES_SUPERUSER_USER
              value: postgres
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_SSLMODE
              value: prefer
            - name: BITNAMI_DEBUG
              value: "false"
          envFrom:
            - secretRef:
                name: freshrss-secrets
          volumeMounts:
            - name: bootstrap-script
              mountPath: /scripts
              readOnly: true
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
      volumes:
        - name: bootstrap-script
          configMap:
            name: freshrss-db-bootstrap
            defaultMode: 0555
