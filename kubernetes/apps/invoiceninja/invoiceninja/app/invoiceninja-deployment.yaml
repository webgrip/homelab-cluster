apiVersion: apps/v1
kind: Deployment
metadata:
  name: invoiceninja
  namespace: invoiceninja
spec:
  replicas: 1
  selector:
    matchLabels:
      app: invoiceninja
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app: invoiceninja
      annotations:
        reloader.stakater.com/auto: "true"
    spec:
      volumes:
        - name: app-data
          emptyDir: {}
        - name: nginx-conf
          configMap:
            name: invoiceninja-nginx
            items:
              - key: default.conf
                path: default.conf
        - name: storage
          persistentVolumeClaim:
            claimName: invoiceninja-storage
      initContainers:
        - name: prepare-storage
          image: busybox:1.36.1
          command:
            - sh
            - -c
            - |
              mkdir -p \
                /storage/storage/app/public \
                /storage/logo;
              chown -R 1500:1500 /storage;
          volumeMounts:
            - name: storage
              mountPath: /storage
        - name: copy-app
          image: invoiceninja/invoiceninja:5.12.39
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 0
            runAsGroup: 0
          command:
            - sh
            - -c
            - >
              set -eu;
              cp -a /var/www/app/. /mnt/app;
              rm -rf /mnt/app/public/storage;
              ln -s ../storage/app/public /mnt/app/public/storage;
              chown -R 1500:1500 /mnt/app;
          volumeMounts:
            - name: app-data
              mountPath: /mnt/app
            - name: storage
              mountPath: /var/www/app/storage
      containers:
        - name: app
          image: invoiceninja/invoiceninja:5.12.39
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: invoiceninja-config
            - secretRef:
                name: invoiceninja-secrets
          env:
            - name: DB_DATABASE
              valueFrom:
                secretKeyRef:
                  name: invoiceninja-secrets
                  key: MARIADB_DATABASE
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: invoiceninja-secrets
                  key: MARIADB_USER
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: invoiceninja-secrets
                  key: DB_PASSWORD
            - name: IN_USER_EMAIL
              valueFrom:
                secretKeyRef:
                  name: invoiceninja-secrets
                  key: IN_USER_EMAIL
            - name: IN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: invoiceninja-secrets
                  key: IN_USER_PASSWORD
          ports:
            - name: fpm
              containerPort: 9000
          volumeMounts:
            - name: app-data
              mountPath: /var/www/app
            - name: storage
              mountPath: /var/www/app/storage
              subPath: storage
            - name: storage
              mountPath: /var/www/app/public/logo
              subPath: logo
          resources:
            requests:
              cpu: 75m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 2Gi

        - name: scheduler
          image: invoiceninja/invoiceninja:5.12.39
          imagePullPolicy: IfNotPresent
          workingDir: /var/www/app
          command:
            - php
            - artisan
            - schedule:work
          envFrom:
            - configMapRef:
                name: invoiceninja-config
            - secretRef:
                name: invoiceninja-secrets
          env:
            - name: DB_DATABASE
              valueFrom:
                secretKeyRef:
                  name: invoiceninja-secrets
                  key: MARIADB_DATABASE
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: invoiceninja-secrets
                  key: MARIADB_USER
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: invoiceninja-secrets
                  key: DB_PASSWORD
            - name: IN_USER_EMAIL
              valueFrom:
                secretKeyRef:
                  name: invoiceninja-secrets
                  key: IN_USER_EMAIL
            - name: IN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: invoiceninja-secrets
                  key: IN_USER_PASSWORD
          securityContext:
            allowPrivilegeEscalation: false
          volumeMounts:
            - name: app-data
              mountPath: /var/www/app
            - name: storage
              mountPath: /var/www/app/storage
              subPath: storage
          resources:
            requests:
              cpu: 40m
              memory: 256Mi
            limits:
              memory: 1Gi

        - name: web
          image: nginxinc/nginx-unprivileged:1.29.1-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
          volumeMounts:
            - name: app-data
              mountPath: /var/www/app
              readOnly: true
            - name: nginx-conf
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
              readOnly: true
            - name: storage
              mountPath: /var/www/app/storage
              subPath: storage
              readOnly: true
            - name: storage
              mountPath: /var/www/app/public/logo
              subPath: logo
              readOnly: true
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 300m
              memory: 256Mi
