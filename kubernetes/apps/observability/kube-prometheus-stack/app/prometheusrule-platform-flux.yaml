apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: platform-flux-rules
  namespace: observability
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: platform.flux
      rules:
        - alert: FluxKustomizationNotReady
          expr: |
            max by (namespace, name) (
              gotk_reconcile_condition{kind="Kustomization", status="False"}
            ) > 0
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Flux Kustomization not Ready ({{$labels.namespace}}/{{$labels.name}})"
            description: "Flux reports Kustomization status=False for 15m. Check `flux get kustomizations` and controller logs."
            runbook_url: "https://backstage.local/docs/default/component/homelab-cluster/runbooks/#flux"

        - alert: FluxHelmReleaseNotReady
          expr: |
            max by (namespace, name) (
              gotk_reconcile_condition{kind="HelmRelease", status="False"}
            ) > 0
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Flux HelmRelease not Ready ({{$labels.namespace}}/{{$labels.name}})"
            description: "Flux reports HelmRelease status=False for 15m. Check `flux get helmreleases` and controller logs."
            runbook_url: "https://backstage.local/docs/default/component/homelab-cluster/runbooks/#flux"
