apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: mimir-kafka-rules
  namespace: observability
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: observability.mimir.kafka
      rules:
        - alert: MimirKafkaCrashLooping
          expr: |
            max by (namespace, pod, container) (
              kube_pod_container_status_waiting_reason{
                namespace="observability",
                pod=~"mimir-distributed-kafka-.*",
                container="kafka",
                reason="CrashLoopBackOff"
              }
            ) > 0
          for: 10m
          labels:
            severity: critical
          annotations:
            summary: "Mimir Kafka is crashlooping ({{ $labels.pod }})"
            description: |
              The Kafka container for Mimir has been in CrashLoopBackOff for 10m.

              Common causes:
              - PVC full (check kubelet_volume_stats_* for the PVC)
              - Read-only filesystem / permissions
              - Corrupt log dir

              Quick checks:
              - kubectl -n observability describe pod {{ $labels.pod }}
              - kubectl -n observability logs {{ $labels.pod }} -c kafka --previous --tail=200

        - alert: MimirKafkaPVCUsageHigh
          expr: |
            100 * (
              kubelet_volume_stats_used_bytes{
                namespace="observability",
                persistentvolumeclaim=~"kafka-data-mimir-distributed-kafka-.*"
              }
              /
              kubelet_volume_stats_capacity_bytes{
                namespace="observability",
                persistentvolumeclaim=~"kafka-data-mimir-distributed-kafka-.*"
              }
            ) > 80
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Mimir Kafka PVC usage > 80% ({{ $labels.persistentvolumeclaim }})"
            description: |
              The Kafka data PVC for Mimir is above 80% for 15m.

              Recommended actions:
              - Increase kafka.persistence.size in the HelmRelease
              - Expand the PVC if supported (Longhorn typically supports this)
              - Ensure Kafka retention caps are set (kafka.extraEnv: KAFKA_LOG_RETENTION_BYTES)

        - alert: MimirKafkaPVCUsageCritical
          expr: |
            100 * (
              kubelet_volume_stats_used_bytes{
                namespace="observability",
                persistentvolumeclaim=~"kafka-data-mimir-distributed-kafka-.*"
              }
              /
              kubelet_volume_stats_capacity_bytes{
                namespace="observability",
                persistentvolumeclaim=~"kafka-data-mimir-distributed-kafka-.*"
              }
            ) > 90
          for: 10m
          labels:
            severity: critical
          annotations:
            summary: "Mimir Kafka PVC usage > 90% ({{ $labels.persistentvolumeclaim }})"
            description: |
              The Kafka data PVC for Mimir is above 90% for 10m. Kafka may crashloop with "No space left on device".

              Immediate mitigation:
              - Expand the PVC (kubectl patch pvc ... storage: <bigger>)
              - Delete the kafka pod to restart after resize (StatefulSet will recreate)

        - alert: MimirKafkaPVCFillingUpSoon
          expr: |
            (
              100 * (
                kubelet_volume_stats_used_bytes{
                  namespace="observability",
                  persistentvolumeclaim=~"kafka-data-mimir-distributed-kafka-.*"
                }
                /
                kubelet_volume_stats_capacity_bytes{
                  namespace="observability",
                  persistentvolumeclaim=~"kafka-data-mimir-distributed-kafka-.*"
                }
              ) > 70
            )
            and
            predict_linear(
              kubelet_volume_stats_available_bytes{
                namespace="observability",
                persistentvolumeclaim=~"kafka-data-mimir-distributed-kafka-.*"
              }[6h],
              12 * 3600
            ) < 0
          for: 30m
          labels:
            severity: warning
          annotations:
            summary: "Mimir Kafka PVC will fill within ~12h ({{ $labels.persistentvolumeclaim }})"
            description: |
              Based on the last 6h growth, the Kafka PVC is predicted to run out of free space within ~12 hours.

              Mitigation:
              - Increase Kafka PVC size
              - Lower Kafka retention (bytes/time) if acceptable
              - Investigate why backlog is growing (mimir components down / consumer lag)
