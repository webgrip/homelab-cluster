---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: app-traffic
  namespace: observability
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: apps.traffic.traces
      rules:
        - alert: AppHttpP95LatencyHigh
          expr: |
            (
              histogram_quantile(
                0.95,
                sum by (k8s_namespace_name, le) (
                  rate(traces_spanmetrics_latency_bucket{span_kind="SPAN_KIND_SERVER", k8s_namespace_name!~"(kube-system|flux-system|observability|cert-manager|cnpg-system|longhorn-system|network|arc-systems)"}[5m])
                )
              ) > 1.5
            )
            and on (k8s_namespace_name)
            (
              sum by (k8s_namespace_name) (
                rate(traces_spanmetrics_calls_total{span_kind="SPAN_KIND_SERVER", k8s_namespace_name!~"(kube-system|flux-system|observability|cert-manager|cnpg-system|longhorn-system|network|arc-systems)"}[5m])
              ) > 0.02
            )
          for: 15m
          labels:
            severity: warning
            owner: platform
            service: apps
          annotations:
            summary: "HTTP p95 latency high ({{ $labels.k8s_namespace_name }})"
            description: |
              What's happening:
              - p95 server latency >1.5s for 15m in namespace {{ $labels.k8s_namespace_name }} (Tempo span-metrics).

              Impact/risk:
              - Users may see slow page loads and timeouts.

              Likely causes:
              - Downstream dependency latency (DB/cache/external API)
              - Resource pressure (CPU throttling, GC, saturation)
              - Increased error retries or traffic spike

              First actions:
              - Use the service graphs/traces to find the slowest edges
              - Check workload CPU/memory and request rate in the namespace
              - Check recent deploys/config changes in the namespace
            runbook_url: "https://backstage.${SECRET_DOMAIN}/docs/default/component/homelab-cluster/runbooks/#apps-baseline"
            dashboard_url: "https://grafana.${SECRET_DOMAIN}/d/tempo-service-graphs/tempo-service-graphs"

        - alert: AppHttpP95LatencyCritical
          expr: |
            (
              histogram_quantile(
                0.95,
                sum by (k8s_namespace_name, le) (
                  rate(traces_spanmetrics_latency_bucket{span_kind="SPAN_KIND_SERVER", k8s_namespace_name!~"(kube-system|flux-system|observability|cert-manager|cnpg-system|longhorn-system|network|arc-systems)"}[5m])
                )
              ) > 3
            )
            and on (k8s_namespace_name)
            (
              sum by (k8s_namespace_name) (
                rate(traces_spanmetrics_calls_total{span_kind="SPAN_KIND_SERVER", k8s_namespace_name!~"(kube-system|flux-system|observability|cert-manager|cnpg-system|longhorn-system|network|arc-systems)"}[5m])
              ) > 0.02
            )
          for: 15m
          labels:
            severity: critical
            owner: platform
            service: apps
          annotations:
            summary: "HTTP p95 latency critical ({{ $labels.k8s_namespace_name }})"
            description: |
              What's happening:
              - p95 server latency >3s for 15m in namespace {{ $labels.k8s_namespace_name }} (Tempo span-metrics).

              Impact/risk:
              - Severe user impact likely (timeouts/unavailability).

              Likely causes:
              - Critical dependency outage or extreme latency
              - Saturation (CPU/memory/IO) causing queuing
              - Misbehaving deployment or config regression

              First actions:
              - Identify the slowest service path in traces/service graphs
              - Check errors and saturation for the top offender services
              - Roll back recent changes if the spike coincides with a deploy
            runbook_url: "https://backstage.${SECRET_DOMAIN}/docs/default/component/homelab-cluster/runbooks/#apps-baseline"
            dashboard_url: "https://grafana.${SECRET_DOMAIN}/d/tempo-service-graphs/tempo-service-graphs"
