---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: app-traffic
spec:
  groups:
    - name: apps.traffic.traces
      rules:
        - alert: AppHttpP95LatencyHigh
          expr: |
            (
              histogram_quantile(
                0.95,
                sum by (k8s_namespace_name, le) (
                  rate(traces_spanmetrics_latency_bucket{span_kind="SPAN_KIND_SERVER", k8s_namespace_name!~"(kube-system|flux-system|observability|cert-manager|cnpg-system|longhorn-system|network|arc-systems)"}[5m])
                )
              ) > 1.5
            )
            and on (k8s_namespace_name)
            (
              sum by (k8s_namespace_name) (
                rate(traces_spanmetrics_calls_total{span_kind="SPAN_KIND_SERVER", k8s_namespace_name!~"(kube-system|flux-system|observability|cert-manager|cnpg-system|longhorn-system|network|arc-systems)"}[5m])
              ) > 0.02
            )
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "High p95 latency ({{ $labels.k8s_namespace_name }})"
            description: "p95 latency >1.5s for 15m (Tempo span-metrics)."
            runbook_url: "https://backstage.local/docs/default/component/homelab-cluster/runbooks/#apps-baseline"

        - alert: AppHttpP95LatencyCritical
          expr: |
            (
              histogram_quantile(
                0.95,
                sum by (k8s_namespace_name, le) (
                  rate(traces_spanmetrics_latency_bucket{span_kind="SPAN_KIND_SERVER", k8s_namespace_name!~"(kube-system|flux-system|observability|cert-manager|cnpg-system|longhorn-system|network|arc-systems)"}[5m])
                )
              ) > 3
            )
            and on (k8s_namespace_name)
            (
              sum by (k8s_namespace_name) (
                rate(traces_spanmetrics_calls_total{span_kind="SPAN_KIND_SERVER", k8s_namespace_name!~"(kube-system|flux-system|observability|cert-manager|cnpg-system|longhorn-system|network|arc-systems)"}[5m])
              ) > 0.02
            )
          for: 15m
          labels:
            severity: critical
          annotations:
            summary: "Critical p95 latency ({{ $labels.k8s_namespace_name }})"
            description: "p95 latency >3s for 15m (Tempo span-metrics)."
            runbook_url: "https://backstage.local/docs/default/component/homelab-cluster/runbooks/#apps-baseline"
