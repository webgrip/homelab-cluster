---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: k6-ingress-canary
  namespace: observability
spec:
  schedule: "*/30 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          annotations:
            reloader.stakater.com/auto: "true"
            configmap.reloader.stakater.com/reload: "k6-canary-script"
        spec:
          serviceAccountName: k6-canary
          restartPolicy: Never
          containers:
            - name: create-testrun
              image: alpine:3.20
              imagePullPolicy: IfNotPresent
              env:
                - name: SECRET_DOMAIN
                  value: ${SECRET_DOMAIN}
              command:
                - /bin/sh
                - -ceu
                - |
                  apk add --no-cache ca-certificates curl

                  # Install a pinned kubectl matching the cluster version.
                  KUBECTL_VERSION="v1.34.2"
                  curl -fsSLo /usr/local/bin/kubectl "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
                  chmod +x /usr/local/bin/kubectl

                  ts="$(date +%s)"
                  name="k6-ingress-canary-$${ts}"

                  cat <<EOF | kubectl apply -f -
                  apiVersion: k6.io/v1alpha1
                  kind: TestRun
                  metadata:
                    name: $${name}
                    namespace: observability
                    labels:
                      app.kubernetes.io/name: k6-ingress-canary
                  spec:
                    parallelism: 1
                    cleanup: post
                    paused: "false"
                    arguments: "--out experimental-prometheus-rw"
                    script:
                      configMap:
                        name: k6-canary-script
                        file: script.js
                    runner:
                      env:
                        - name: SECRET_DOMAIN
                          value: "${SECRET_DOMAIN}"
                        - name: K6_PROMETHEUS_RW_SERVER_URL
                          value: "http://kube-prometheus-stack-prometheus.observability.svc.cluster.local:9090/api/v1/write"
                  EOF
