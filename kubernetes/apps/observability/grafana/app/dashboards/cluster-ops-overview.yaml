apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-cluster-ops-overview
  namespace: observability
  annotations:
    grafana_folder: Platform
  labels:
    grafana_dashboard: "1"
data:
  cluster-ops-overview.json: |-
    {
      "schemaVersion": 39,
      "title": "Cluster / Ops Overview",
      "uid": "obs-stack-overview",
      "timezone": "browser",
      "tags": ["cluster", "ops", "gitops", "flux"],
      "description": "At-a-glance cluster ops view: workload health plus Flux change/error markers via Grafana annotations. Use 'Event namespace' to scope which namespace-tagged change/error markers you see.",
      "editable": false,
      "graphTooltip": 1,
      "refresh": "1m",
      "time": {"from": "now-6h", "to": "now"},
      "timepicker": {
        "refresh_intervals": ["10s", "30s", "1m", "5m", "15m", "30m", "1h"],
        "time_options": ["5m", "15m", "30m", "1h", "3h", "6h", "12h", "24h", "2d", "7d"]
      },
      "templating": {
        "list": [
          {
            "type": "query",
            "name": "namespace",
            "label": "Workload namespace",
            "datasource": {"type": "prometheus", "uid": "prometheus"},
            "query": {"query": "label_values(kube_pod_info, namespace)", "refId": "PromQuery"},
            "sort": 1,
            "refresh": 1,
            "multi": true,
            "includeAll": true,
            "allValue": ".*",
            "current": {"text": "All", "value": "$__all"}
          },
          {
            "type": "query",
            "name": "event_namespace",
            "label": "Event namespace",
            "datasource": {"type": "prometheus", "uid": "prometheus"},
            "query": {"query": "label_values(kube_pod_info, namespace)", "refId": "PromQuery"},
            "sort": 1,
            "refresh": 1,
            "multi": false,
            "includeAll": false,
            "current": {"text": "flux-system", "value": "flux-system"}
          },
          {
            "type": "custom",
            "name": "flux_controller",
            "label": "Flux controller",
            "query": "kustomize-controller,helm-controller,source-controller,notification-controller",
            "multi": true,
            "includeAll": true,
            "allValue": ".*",
            "current": {"text": "All", "value": "$__all"}
          },
          {
            "type": "query",
            "name": "pod",
            "label": "Pod",
            "datasource": {"type": "prometheus", "uid": "prometheus"},
            "query": {"query": "label_values(kube_pod_container_status_restarts_total{namespace=~\"$namespace\"}, pod)", "refId": "PromQuery"},
            "sort": 1,
            "refresh": 1,
            "multi": true,
            "includeAll": true,
            "allValue": ".*",
            "current": {"text": "All", "value": "$__all"}
          },
          {
            "type": "custom",
            "name": "topk",
            "label": "Top K",
            "query": "5,10,20",
            "multi": false,
            "includeAll": false,
            "current": {"text": "10", "value": "10"}
          },
          {
            "type": "custom",
            "name": "container_selector",
            "label": "(internal) container selector",
            "query": "container!=\"\",container!=\"POD\"",
            "hide": 2,
            "multi": false,
            "includeAll": false,
            "current": {"text": "container!=\"\",container!=\"POD\"", "value": "container!=\"\",container!=\"POD\""}
          },
          {
            "type": "custom",
            "name": "cpu_resource_selector",
            "label": "(internal) cpu resource selector",
            "query": "resource=\"cpu\",unit=\"core\"",
            "hide": 2,
            "multi": false,
            "includeAll": false,
            "current": {"text": "resource=\"cpu\",unit=\"core\"", "value": "resource=\"cpu\",unit=\"core\""}
          },
          {
            "type": "custom",
            "name": "memory_resource_selector",
            "label": "(internal) memory resource selector",
            "query": "resource=\"memory\",unit=\"byte\"",
            "hide": 2,
            "multi": false,
            "includeAll": false,
            "current": {"text": "resource=\"memory\",unit=\"byte\"", "value": "resource=\"memory\",unit=\"byte\""}
          }
        ]
      },
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {"type": "grafana", "uid": "-- Grafana --"},
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          },
          {
            "datasource": {"type": "grafana", "uid": "-- Grafana --"},
            "enable": true,
            "hide": false,
            "iconColor": "rgba(170, 170, 170, 1)",
            "name": "Flux changes",
            "type": "tags",
            "tags": ["flux", "flux_event:change", "namespace:$event_namespace"],
            "matchAny": false
          },
          {
            "datasource": {"type": "grafana", "uid": "-- Grafana --"},
            "enable": true,
            "hide": false,
            "iconColor": "rgba(255, 85, 85, 1)",
            "name": "Flux errors",
            "type": "tags",
            "tags": ["flux", "flux_event:error", "namespace:$event_namespace"],
            "matchAny": false
          }
        ]
      },
      "panels": [
        {
          "id": 90,
          "type": "row",
          "title": "Scope & Scoreboard",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0},
          "collapsed": false,
          "panels": []
        },
        {
          "id": 1,
          "type": "stat",
          "title": "Nodes Ready (%)",
          "description": "Percent of nodes reporting Ready=True.",
          "gridPos": {"h": 4, "w": 4, "x": 0, "y": 1},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "100 * sum(kube_node_status_condition{condition=\"Ready\", status=\"true\"}) / clamp_min(count(kube_node_info), 1)"
            }
          ],
          "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "orientation": "auto", "textMode": "auto"},
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "decimals": 0,
              "min": 0,
              "max": 100,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "red", "value": null},
                  {"color": "orange", "value": 90},
                  {"color": "green", "value": 99}
                ]
              }
            },
            "overrides": []
          }
        },
        {
          "id": 2,
          "type": "stat",
          "title": "Pods Ready (%)",
          "description": "Percent of pods Ready=True in selected workload namespaces.",
          "gridPos": {"h": 4, "w": 4, "x": 4, "y": 1},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "100 * (sum(max by (namespace, pod) (kube_pod_status_ready{namespace=~\"$namespace\", condition=\"true\"})) / clamp_min(sum(max by (namespace, pod) (kube_pod_status_ready{namespace=~\"$namespace\", condition=~\"true|false\"})), 1))"
            }
          ],
          "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "orientation": "auto", "textMode": "auto"},
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "decimals": 0,
              "min": 0,
              "max": 100,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "red", "value": null},
                  {"color": "orange", "value": 90},
                  {"color": "green", "value": 99}
                ]
              }
            },
            "overrides": []
          }
        },
        {
          "id": 3,
          "type": "stat",
          "title": "Workloads not Ready",
          "description": "Count of Deployments/StatefulSets/DaemonSets that are not at desired replicas.",
          "gridPos": {"h": 4, "w": 4, "x": 8, "y": 1},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "(count((kube_deployment_spec_replicas{namespace=~\"$namespace\"} - kube_deployment_status_replicas_available{namespace=~\"$namespace\"}) > 0) + count((kube_statefulset_replicas{namespace=~\"$namespace\"} - kube_statefulset_status_replicas_ready{namespace=~\"$namespace\"}) > 0) + count((kube_daemonset_status_desired_number_scheduled{namespace=~\"$namespace\"} - kube_daemonset_status_number_ready{namespace=~\"$namespace\"}) > 0)) or vector(0)"
            }
          ],
          "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "orientation": "auto", "textMode": "auto"},
          "fieldConfig": {
            "defaults": {
              "decimals": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 1},
                  {"color": "red", "value": 3}
                ]
              }
            },
            "overrides": []
          }
        },
        {
          "id": 11,
          "type": "stat",
          "title": "Alerts firing",
          "description": "Total Prometheus alerts firing right now (all namespaces).",
          "gridPos": {"h": 4, "w": 4, "x": 12, "y": 1},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "count(ALERTS{alertstate=\"firing\"}) or vector(0)"
            }
          ],
          "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "orientation": "auto", "textMode": "auto"},
          "fieldConfig": {
            "defaults": {
              "decimals": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 1},
                  {"color": "red", "value": 5}
                ]
              }
            },
            "overrides": []
          }
        },
        {
          "id": 12,
          "type": "stat",
          "title": "PVCs Pending",
          "description": "Pending PVCs in selected workload namespaces.",
          "gridPos": {"h": 4, "w": 4, "x": 16, "y": 1},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "sum(kube_persistentvolumeclaim_status_phase{namespace=~\"$namespace\", phase=\"Pending\"}) or vector(0)"
            }
          ],
          "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "orientation": "auto", "textMode": "auto"},
          "fieldConfig": {
            "defaults": {
              "decimals": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 1},
                  {"color": "red", "value": 3}
                ]
              }
            },
            "overrides": []
          }
        },
        {
          "id": 13,
          "type": "stat",
          "title": "Restarts (last 30m)",
          "description": "Total container restarts in $namespace over the last 30 minutes.",
          "gridPos": {"h": 4, "w": 4, "x": 20, "y": 1},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "sum(increase(kube_pod_container_status_restarts_total{namespace=~\"$namespace\"}[30m])) or vector(0)"
            }
          ],
          "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "orientation": "auto", "textMode": "auto"},
          "fieldConfig": {
            "defaults": {
              "decimals": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 1},
                  {"color": "red", "value": 5}
                ]
              }
            },
            "overrides": []
          }
        },
        {
          "id": 94,
          "type": "row",
          "title": "Cluster",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 5},
          "collapsed": false,
          "panels": []
        },
        {
          "id": 50,
          "type": "timeseries",
          "title": "API server 5xx rate",
          "description": "Requests/s returning 5xx (cluster-wide).",
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 6},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(apiserver_request_total{code=~\"5..\"}[5m])) or vector(0)",
              "legendFormat": "5xx/s"
            }
          ],
          "options": {"legend": {"displayMode": "hidden"}, "tooltip": {"mode": "single"}},
          "fieldConfig": {"defaults": {"unit": "reqps", "decimals": 3}, "overrides": []}
        },
        {
          "id": 51,
          "type": "timeseries",
          "title": "CoreDNS errors rate",
          "description": "SERVFAIL/NXDOMAIN responses/s (cluster-wide).",
          "gridPos": {"h": 7, "w": 12, "x": 12, "y": 6},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(coredns_dns_responses_total{rcode=~\"SERVFAIL|NXDOMAIN\"}[5m])) or vector(0)",
              "legendFormat": "errors/s"
            }
          ],
          "options": {"legend": {"displayMode": "hidden"}, "tooltip": {"mode": "single"}},
          "fieldConfig": {"defaults": {"unit": "ops", "decimals": 3}, "overrides": []}
        },
        {
          "id": 91,
          "type": "row",
          "title": "Workloads ($namespace)",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 13},
          "collapsed": false,
          "panels": []
        },
        {
          "id": 24,
          "type": "timeseries",
          "title": "CPU usage vs requests (namespace)",
          "description": "Usage (cores) compared to requested CPU for selected workload namespaces.",
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 14},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=~\"$namespace\", $container_selector}[5m])) or vector(0)",
              "legendFormat": "usage"
            },
            {
              "refId": "B",
              "expr": "sum(kube_pod_container_resource_requests{namespace=~\"$namespace\", $cpu_resource_selector}) or vector(0)",
              "legendFormat": "requests"
            },
            {
              "refId": "C",
              "expr": "sum(kube_pod_container_resource_limits{namespace=~\"$namespace\", $cpu_resource_selector}) or vector(0)",
              "legendFormat": "limits"
            },
            {
              "refId": "D",
              "expr": "sum(kube_node_status_allocatable{$cpu_resource_selector})",
              "legendFormat": "allocatable"
            }
          ],
          "options": {"legend": {"displayMode": "list", "placement": "right"}},
          "fieldConfig": {
            "defaults": {"unit": "cores"},
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "limits"},
                "properties": [
                  {"id": "color", "value": {"mode": "fixed", "fixedColor": "orange"}},
                  {"id": "custom.lineWidth", "value": 2}
                ]
              },
              {
                "matcher": {"id": "byName", "options": "allocatable"},
                "properties": [
                  {"id": "color", "value": {"mode": "fixed", "fixedColor": "red"}},
                  {"id": "custom.lineWidth", "value": 2}
                ]
              }
            ]
          }
        },
        {
          "id": 25,
          "type": "timeseries",
          "title": "Memory usage vs requests (namespace)",
          "description": "Working set compared to requested memory for selected workload namespaces.",
          "gridPos": {"h": 7, "w": 12, "x": 12, "y": 14},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "sum(container_memory_working_set_bytes{namespace=~\"$namespace\", $container_selector}) or vector(0)",
              "legendFormat": "usage"
            },
            {
              "refId": "B",
              "expr": "sum(kube_pod_container_resource_requests{namespace=~\"$namespace\", $memory_resource_selector}) or vector(0)",
              "legendFormat": "requests"
            },
            {
              "refId": "C",
              "expr": "sum(kube_pod_container_resource_limits{namespace=~\"$namespace\", $memory_resource_selector}) or vector(0)",
              "legendFormat": "limits"
            },
            {
              "refId": "D",
              "expr": "sum(kube_node_status_allocatable{$memory_resource_selector})",
              "legendFormat": "allocatable"
            }
          ],
          "options": {"legend": {"displayMode": "list", "placement": "right"}},
          "fieldConfig": {
            "defaults": {"unit": "bytes"},
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "limits"},
                "properties": [
                  {"id": "color", "value": {"mode": "fixed", "fixedColor": "orange"}},
                  {"id": "custom.lineWidth", "value": 2}
                ]
              },
              {
                "matcher": {"id": "byName", "options": "allocatable"},
                "properties": [
                  {"id": "color", "value": {"mode": "fixed", "fixedColor": "red"}},
                  {"id": "custom.lineWidth", "value": 2}
                ]
              }
            ]
          }
        },
        {
          "id": 26,
          "type": "table",
          "title": "Workloads missing replicas (current)",
          "description": "Deployments with missing replicas (desired - available).",
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 29},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "max by (namespace, deployment) (kube_deployment_spec_replicas{namespace=~\"$namespace\"} - kube_deployment_status_replicas_available{namespace=~\"$namespace\"}) > 0"
            }
          ],
          "transformations": [
            {"id": "labelsToFields", "options": {}},
            {"id": "organize", "options": {"excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true}, "indexByName": {"namespace": 0, "deployment": 1, "Value": 2}, "renameByName": {"Value": "missing"}}},
            {"id": "sortBy", "options": {"sort": [{"field": "missing", "desc": true}]}}
          ],
          "fieldConfig": {"defaults": {"decimals": 0}, "overrides": []},
          "options": {"showHeader": true}
        },
        {
          "id": 27,
          "type": "table",
          "title": "OOMKilled (last termination time)",
          "description": "Containers whose last termination reason was OOMKilled, showing the last terminated finished timestamp (requires kube-state-metrics finished_time metric).",
          "gridPos": {"h": 7, "w": 12, "x": 12, "y": 29},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "max by (namespace, pod, container) (kube_pod_container_status_last_terminated_finished_time{namespace=~\"$namespace\"}) and on (namespace, pod, container) (kube_pod_container_status_last_terminated_reason{namespace=~\"$namespace\", reason=\"OOMKilled\"} == 1)"
            }
          ],
          "transformations": [
            {"id": "labelsToFields", "options": {}},
            {"id": "organize", "options": {"excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true}, "indexByName": {"namespace": 0, "pod": 1, "container": 2, "Value": 3}, "renameByName": {"Value": "oomkilled_at"}}},
            {"id": "sortBy", "options": {"sort": [{"field": "oomkilled_at", "desc": true}]}}
          ],
          "fieldConfig": {"defaults": {"unit": "dateTimeFromEpoch", "decimals": 0}, "overrides": []},
          "options": {"showHeader": true}
        },
        {
          "id": 28,
          "type": "table",
          "title": "Top CPU (namespace/pod/container)",
          "description": "Top CPU consumers by container (rate over 5m). Use this to explain sustained high CPU in a namespace.",
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 36},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "topk($topk, sum by (namespace, pod, container) (rate(container_cpu_usage_seconds_total{namespace=~\"$namespace\", $container_selector}[5m])))"
            }
          ],
          "transformations": [
            {"id": "labelsToFields", "options": {}},
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true},
                "indexByName": {"namespace": 0, "pod": 1, "container": 2, "Value": 3},
                "renameByName": {"Value": "cpu_cores"}
              }
            },
            {"id": "sortBy", "options": {"sort": [{"field": "cpu_cores", "desc": true}]}}
          ],
          "fieldConfig": {"defaults": {"unit": "cores"}, "overrides": []},
          "options": {"showHeader": true}
        },
        {
          "id": 29,
          "type": "table",
          "title": "Top memory (namespace/pod/container)",
          "description": "Top memory consumers by container (working set). Use this to explain OOMs and sustained memory pressure.",
          "gridPos": {"h": 7, "w": 12, "x": 12, "y": 36},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "topk($topk, sum by (namespace, pod, container) (container_memory_working_set_bytes{namespace=~\"$namespace\", $container_selector}))"
            }
          ],
          "transformations": [
            {"id": "labelsToFields", "options": {}},
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true},
                "indexByName": {"namespace": 0, "pod": 1, "container": 2, "Value": 3},
                "renameByName": {"Value": "memory_bytes"}
              }
            },
            {"id": "sortBy", "options": {"sort": [{"field": "memory_bytes", "desc": true}]}}
          ],
          "fieldConfig": {"defaults": {"unit": "bytes"}, "overrides": []},
          "options": {"showHeader": true}
        },
        {
          "id": 20,
          "type": "timeseries",
          "title": "Pod restarts (top $topk, 30m)",
          "description": "Helps spot crash loops quickly. Markers: Flux changes/errors via annotations.",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 43},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "topk($topk, sum by (namespace, pod) (increase(kube_pod_container_status_restarts_total{namespace=~\"$namespace\", pod=~\"$pod\"}[30m])))",
              "legendFormat": "{{namespace}}/{{pod}}"
            }
          ],
          "fieldConfig": {"defaults": {"decimals": 0, "min": 0}, "overrides": []},
          "options": {
            "legend": {"displayMode": "list", "placement": "right"},
            "tooltip": {"mode": "multi", "sort": "desc"}
          }
        },
        {
          "id": 21,
          "type": "timeseries",
          "title": "CPU usage (top $topk)",
          "description": "CPU cores per pod (rate over 5m).",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 43},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "topk($topk, sum by (namespace, pod) (rate(container_cpu_usage_seconds_total{namespace=~\"$namespace\", pod=~\"$pod\", $container_selector}[5m])))",
              "legendFormat": "{{namespace}}/{{pod}}"
            }
          ],
          "fieldConfig": {"defaults": {"unit": "cores"}, "overrides": []},
          "options": {
            "legend": {"displayMode": "list", "placement": "right"},
            "tooltip": {"mode": "multi", "sort": "desc"}
          }
        },
        {
          "id": 22,
          "type": "timeseries",
          "title": "Memory usage (top $topk)",
          "description": "Working set bytes per pod.",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 51},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "topk($topk, sum by (namespace, pod) (container_memory_working_set_bytes{namespace=~\"$namespace\", pod=~\"$pod\", $container_selector}))",
              "legendFormat": "{{namespace}}/{{pod}}"
            }
          ],
          "fieldConfig": {"defaults": {"unit": "bytes"}, "overrides": []},
          "options": {
            "legend": {"displayMode": "list", "placement": "right"},
            "tooltip": {"mode": "multi", "sort": "desc"}
          }
        },
        {
          "id": 23,
          "type": "timeseries",
          "title": "PVC usage (top $topk)",
          "description": "Used / capacity by PVC; values are 0..1.",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 51},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "topk($topk, (kubelet_volume_stats_used_bytes{namespace=~\"$namespace\"} / kubelet_volume_stats_capacity_bytes{namespace=~\"$namespace\"}))",
              "legendFormat": "{{persistentvolumeclaim}}"
            }
          ],
          "fieldConfig": {"defaults": {"unit": "percentunit", "min": 0, "max": 1}, "overrides": []},
          "options": {
            "legend": {"displayMode": "list", "placement": "right"},
            "tooltip": {"mode": "multi", "sort": "desc"}
          }
        },
        {
          "id": 34,
          "type": "timeseries",
          "title": "CPU throttling ratio (%)",
          "description": "Throttled periods / total periods (container CPU CFS). High values indicate CPU limits contention.",
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 59},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "100 * sum(rate(container_cpu_cfs_throttled_periods_total{namespace=~\"$namespace\", $container_selector}[5m])) / clamp_min(sum(rate(container_cpu_cfs_periods_total{namespace=~\"$namespace\", $container_selector}[5m])), 1)",
              "legendFormat": "throttling%"
            }
          ],
          "options": {"legend": {"displayMode": "hidden"}, "tooltip": {"mode": "single"}},
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "decimals": 1,
              "min": 0,
              "max": 100,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 10},
                  {"color": "red", "value": 25}
                ]
              }
            },
            "overrides": []
          }
        },
        {
          "id": 35,
          "type": "timeseries",
          "title": "Node pressure (count)",
          "description": "Number of nodes reporting pressure conditions (should be 0).",
          "gridPos": {"h": 7, "w": 12, "x": 12, "y": 59},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "sum(kube_node_status_condition{condition=\"MemoryPressure\", status=\"true\"})",
              "legendFormat": "MemoryPressure"
            },
            {
              "refId": "B",
              "expr": "sum(kube_node_status_condition{condition=\"DiskPressure\", status=\"true\"})",
              "legendFormat": "DiskPressure"
            },
            {
              "refId": "C",
              "expr": "sum(kube_node_status_condition{condition=\"PIDPressure\", status=\"true\"})",
              "legendFormat": "PIDPressure"
            }
          ],
          "options": {"legend": {"displayMode": "list", "placement": "right"}, "tooltip": {"mode": "multi"}},
          "fieldConfig": {
            "defaults": {
              "decimals": 0,
              "min": 0,
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 1}]}
            },
            "overrides": []
          }
        },
        {
          "id": 95,
          "type": "row",
          "title": "Right-sizing ($namespace)",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 21},
          "collapsed": false,
          "panels": []
        },
        {
          "id": 45,
          "type": "table",
          "title": "CPU headroom vs peak usage (requests/limits - peak, top $topk)",
          "description": "Shows request/limit headroom per container against peak CPU usage over the dashboard time range. High headroom suggests you can lower requests/limits.",
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 22},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "topk($topk, label_replace(clamp_min(max by (namespace, pod, container) (kube_pod_container_resource_requests{namespace=~\"$namespace\", $cpu_resource_selector}) - max_over_time((sum by (namespace, pod, container) (rate(container_cpu_usage_seconds_total{namespace=~\"$namespace\", $container_selector}[5m])) )[$__range:]), 0), \"bound\", \"requests\", \"namespace\", \".*\")) or topk($topk, label_replace(clamp_min(max by (namespace, pod, container) (kube_pod_container_resource_limits{namespace=~\"$namespace\", $cpu_resource_selector}) - max_over_time((sum by (namespace, pod, container) (rate(container_cpu_usage_seconds_total{namespace=~\"$namespace\", $container_selector}[5m])) )[$__range:]), 0), \"bound\", \"limits\", \"namespace\", \".*\"))",
              "instant": true,
              "range": false
            }
          ],
          "transformations": [
            {"id": "labelsToFields", "options": {}},
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true},
                "indexByName": {"namespace": 0, "pod": 1, "container": 2, "bound": 3, "Value": 4},
                "renameByName": {"Value": "headroom_cores"}
              }
            },
            {"id": "sortBy", "options": {"sort": [{"field": "headroom_cores", "desc": true}]}}
          ],
          "fieldConfig": {"defaults": {"unit": "cores", "decimals": 3}, "overrides": []},
          "options": {"showHeader": true}
        },
        {
          "id": 46,
          "type": "table",
          "title": "Memory headroom vs peak usage (requests/limits - peak, top $topk)",
          "description": "Shows request/limit headroom per container against peak working set over the dashboard time range.",
          "gridPos": {"h": 7, "w": 12, "x": 12, "y": 22},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "topk($topk, label_replace(clamp_min(max by (namespace, pod, container) (kube_pod_container_resource_requests{namespace=~\"$namespace\", $memory_resource_selector}) - max_over_time((sum by (namespace, pod, container) (container_memory_working_set_bytes{namespace=~\"$namespace\", $container_selector}))[$__range:]), 0), \"bound\", \"requests\", \"namespace\", \".*\")) or topk($topk, label_replace(clamp_min(max by (namespace, pod, container) (kube_pod_container_resource_limits{namespace=~\"$namespace\", $memory_resource_selector}) - max_over_time((sum by (namespace, pod, container) (container_memory_working_set_bytes{namespace=~\"$namespace\", $container_selector}))[$__range:]), 0), \"bound\", \"limits\", \"namespace\", \".*\"))",
              "instant": true,
              "range": false
            }
          ],
          "transformations": [
            {"id": "labelsToFields", "options": {}},
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true},
                "indexByName": {"namespace": 0, "pod": 1, "container": 2, "bound": 3, "Value": 4},
                "renameByName": {"Value": "headroom_bytes"}
              }
            },
            {"id": "sortBy", "options": {"sort": [{"field": "headroom_bytes", "desc": true}]}}
          ],
          "fieldConfig": {"defaults": {"unit": "bytes", "decimals": 0}, "overrides": []},
          "options": {"showHeader": true}
        },
        {
          "id": 37,
          "type": "bargauge",
          "title": "CPU requests/limits (% of allocatable)",
          "description": "Per-namespace CPU requests/limits as a percent of cluster allocatable CPU. Great for spotting overcommit before it bites.",
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 66},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "topk($topk, 100 * sum by (namespace) (kube_pod_container_resource_requests{namespace=~\"$namespace\", $cpu_resource_selector}) / clamp_min(sum(kube_node_status_allocatable{$cpu_resource_selector}), 1))",
              "legendFormat": "{{namespace}} requests",
              "instant": true,
              "range": false
            },
            {
              "refId": "B",
              "expr": "topk($topk, 100 * sum by (namespace) (kube_pod_container_resource_limits{namespace=~\"$namespace\", $cpu_resource_selector}) / clamp_min(sum(kube_node_status_allocatable{$cpu_resource_selector}), 1))",
              "legendFormat": "{{namespace}} limits",
              "instant": true,
              "range": false
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "decimals": 1,
              "min": 0,
              "max": 200,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 60},
                  {"color": "red", "value": 90}
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "orientation": "horizontal",
            "displayMode": "gradient",
            "showUnfilled": true,
            "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}
          }
        },
        {
          "id": 38,
          "type": "bargauge",
          "title": "Memory requests/limits (% of allocatable)",
          "description": "Per-namespace memory requests/limits as a percent of cluster allocatable memory.",
          "gridPos": {"h": 7, "w": 12, "x": 12, "y": 66},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "topk($topk, 100 * sum by (namespace) (kube_pod_container_resource_requests{namespace=~\"$namespace\", $memory_resource_selector}) / clamp_min(sum(kube_node_status_allocatable{$memory_resource_selector}), 1))",
              "legendFormat": "{{namespace}} requests",
              "instant": true,
              "range": false
            },
            {
              "refId": "B",
              "expr": "topk($topk, 100 * sum by (namespace) (kube_pod_container_resource_limits{namespace=~\"$namespace\", $memory_resource_selector}) / clamp_min(sum(kube_node_status_allocatable{$memory_resource_selector}), 1))",
              "legendFormat": "{{namespace}} limits",
              "instant": true,
              "range": false
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "decimals": 1,
              "min": 0,
              "max": 200,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 60},
                  {"color": "red", "value": 90}
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "orientation": "horizontal",
            "displayMode": "gradient",
            "showUnfilled": true,
            "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}
          }
        },
        {
          "id": 43,
          "type": "stat",
          "title": "CPU limits overcommit namespaces",
          "description": "How many selected namespaces have CPU limits > 100% of cluster allocatable.",
          "gridPos": {"h": 3, "w": 12, "x": 0, "y": 73},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "count((100 * sum by (namespace) (kube_pod_container_resource_limits{namespace=~\"$namespace\", $cpu_resource_selector}) / clamp_min(sum(kube_node_status_allocatable{$cpu_resource_selector}), 1)) > 100) or vector(0)"
            }
          ],
          "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "orientation": "auto", "textMode": "value"},
          "fieldConfig": {
            "defaults": {
              "decimals": 0,
              "min": 0,
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "orange", "value": 1}, {"color": "red", "value": 3}]}
            },
            "overrides": []
          }
        },
        {
          "id": 44,
          "type": "stat",
          "title": "Memory limits overcommit namespaces",
          "description": "How many selected namespaces have memory limits > 100% of cluster allocatable.",
          "gridPos": {"h": 3, "w": 12, "x": 12, "y": 73},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "count((100 * sum by (namespace) (kube_pod_container_resource_limits{namespace=~\"$namespace\", $memory_resource_selector}) / clamp_min(sum(kube_node_status_allocatable{$memory_resource_selector}), 1)) > 100) or vector(0)"
            }
          ],
          "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "orientation": "auto", "textMode": "value"},
          "fieldConfig": {
            "defaults": {
              "decimals": 0,
              "min": 0,
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "orange", "value": 1}, {"color": "red", "value": 3}]}
            },
            "overrides": []
          }
        },
        {
          "id": 41,
          "type": "table",
          "title": "CPU limits overcommit (>100% allocatable)",
          "description": "Namespaces where summed CPU limits exceed cluster allocatable CPU.",
          "gridPos": {"h": 5, "w": 12, "x": 0, "y": 76},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "(100 * sum by (namespace) (kube_pod_container_resource_limits{namespace=~\"$namespace\", $cpu_resource_selector}) / clamp_min(sum(kube_node_status_allocatable{$cpu_resource_selector}), 1)) and on (namespace) ((100 * sum by (namespace) (kube_pod_container_resource_limits{namespace=~\"$namespace\", $cpu_resource_selector}) / clamp_min(sum(kube_node_status_allocatable{$cpu_resource_selector}), 1)) > 100)"
            }
          ],
          "transformations": [
            {"id": "labelsToFields", "options": {}},
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true},
                "indexByName": {"namespace": 0, "Value": 1},
                "renameByName": {"Value": "cpu_limits_percent"}
              }
            },
            {"id": "sortBy", "options": {"sort": [{"field": "cpu_limits_percent", "desc": true}]}}
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "decimals": 1,
              "thresholds": {"mode": "absolute", "steps": [{"color": "orange", "value": null}, {"color": "red", "value": 100}]}
            },
            "overrides": []
          },
          "options": {"showHeader": true}
        },
        {
          "id": 42,
          "type": "table",
          "title": "Memory limits overcommit (>100% allocatable)",
          "description": "Namespaces where summed memory limits exceed cluster allocatable memory.",
          "gridPos": {"h": 5, "w": 12, "x": 12, "y": 76},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "(100 * sum by (namespace) (kube_pod_container_resource_limits{namespace=~\"$namespace\", $memory_resource_selector}) / clamp_min(sum(kube_node_status_allocatable{$memory_resource_selector}), 1)) and on (namespace) ((100 * sum by (namespace) (kube_pod_container_resource_limits{namespace=~\"$namespace\", $memory_resource_selector}) / clamp_min(sum(kube_node_status_allocatable{$memory_resource_selector}), 1)) > 100)"
            }
          ],
          "transformations": [
            {"id": "labelsToFields", "options": {}},
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true},
                "indexByName": {"namespace": 0, "Value": 1},
                "renameByName": {"Value": "memory_limits_percent"}
              }
            },
            {"id": "sortBy", "options": {"sort": [{"field": "memory_limits_percent", "desc": true}]}}
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "decimals": 1,
              "thresholds": {"mode": "absolute", "steps": [{"color": "orange", "value": null}, {"color": "red", "value": 100}]}
            },
            "overrides": []
          },
          "options": {"showHeader": true}
        },
        {
          "id": 39,
          "type": "table",
          "title": "Top CPU throttled containers (%)",
          "description": "Top containers by CPU throttling ratio (throttled periods / total periods over 5m). High values often mean CPU limits are too tight.",
          "gridPos": {"h": 7, "w": 24, "x": 0, "y": 81},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "topk($topk, 100 * sum by (namespace, pod, container) (rate(container_cpu_cfs_throttled_periods_total{namespace=~\"$namespace\", $container_selector}[5m])) / clamp_min(sum by (namespace, pod, container) (rate(container_cpu_cfs_periods_total{namespace=~\"$namespace\", $container_selector}[5m])), 1))"
            }
          ],
          "transformations": [
            {"id": "labelsToFields", "options": {}},
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true},
                "indexByName": {"namespace": 0, "pod": 1, "container": 2, "Value": 3},
                "renameByName": {"Value": "throttling_percent"}
              }
            },
            {"id": "sortBy", "options": {"sort": [{"field": "throttling_percent", "desc": true}]}}
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "decimals": 1,
              "min": 0,
              "max": 100,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "orange", "value": 10},
                  {"color": "red", "value": 25}
                ]
              }
            },
            "overrides": []
          },
          "options": {"showHeader": true}
        },
        {
          "id": 92,
          "type": "row",
          "title": "Flux",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 89},
          "collapsed": false,
          "panels": []
        },
        {
          "id": 32,
          "type": "timeseries",
          "title": "Reconcile duration p95 (by kind)",
          "description": "p95 reconcile latency by kind.",
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 90},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum by (le, kind) (rate(gotk_reconcile_duration_seconds_bucket[5m])))",
              "legendFormat": "{{kind}}"
            }
          ],
          "options": {"legend": {"displayMode": "list", "placement": "right"}},
          "fieldConfig": {"defaults": {"unit": "s"}, "overrides": []}
        },
        {
          "id": 33,
          "type": "table",
          "title": "Flux events (annotations)",
          "description": "Recent Flux change/error annotations for the selected event namespace.",
          "gridPos": {"h": 7, "w": 12, "x": 12, "y": 90},
          "datasource": {"type": "grafana", "uid": "-- Grafana --"},
          "targets": [
            {
              "refId": "A",
              "type": "annotations",
              "limit": 50,
              "tags": ["flux", "namespace:$event_namespace"],
              "matchAny": false
            }
          ],
          "options": {"showHeader": true}
        },
        {
          "id": 36,
          "type": "table",
          "title": "Flux events (global)",
          "description": "Recent Flux change/error annotations across all namespaces (namespace tag not required).",
          "gridPos": {"h": 7, "w": 24, "x": 0, "y": 97},
          "datasource": {"type": "grafana", "uid": "-- Grafana --"},
          "targets": [
            {
              "refId": "A",
              "type": "annotations",
              "limit": 50,
              "tags": ["flux"],
              "matchAny": false
            }
          ],
          "options": {"showHeader": true}
        },
        {
          "id": 30,
          "type": "timeseries",
          "title": "Flux failing reconcilers (over time)",
          "description": "Counts Ready=False by kind. Use the annotations toggles to correlate failures with actual changes.",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 104},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (kind) (max_over_time(gotk_reconcile_condition{status=\"False\"}[5m]))",
              "legendFormat": "{{kind}}"
            }
          ],
          "fieldConfig": {"defaults": {"decimals": 0, "min": 0}, "overrides": []},
          "options": {
            "legend": {"displayMode": "list", "placement": "right"},
            "tooltip": {"mode": "multi", "sort": "desc"}
          }
        },
        {
          "id": 31,
          "type": "table",
          "title": "Failing reconcilers (current)",
          "description": "List of Kustomizations/HelmReleases currently reporting Ready=False.",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 104},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "refId": "A",
              "expr": "max by (namespace, kind, name) (gotk_reconcile_condition{kind=~\"Kustomization|HelmRelease\", status=\"False\"})"
            }
          ],
          "transformations": [
            {"id": "labelsToFields", "options": {}},
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true},
                "indexByName": {"namespace": 0, "kind": 1, "name": 2, "Value": 3},
                "renameByName": {"Value": "failing"}
              }
            },
            {"id": "sortBy", "options": {"sort": [{"field": "namespace", "desc": false}, {"field": "kind", "desc": false}, {"field": "name", "desc": false}]}}
          ],
          "fieldConfig": {"defaults": {"decimals": 0}, "overrides": []},
          "options": {"showHeader": true}
        },
        {
          "id": 93,
          "type": "row",
          "title": "Logs",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 112},
          "collapsed": true,
          "panels": []
        },
        {
          "id": 40,
          "type": "logs",
          "title": "Flux logs (changes & failures)",
          "description": "Raw controller logs for quick context. Prefer the annotation markers for change detection; use this panel for details.",
          "gridPos": {"h": 12, "w": 24, "x": 0, "y": 113},
          "datasource": {"type": "loki", "uid": "loki"},
          "targets": [
            {
              "refId": "A",
              "expr": "{namespace=\"flux-system\", pod=~\"($flux_controller).*\"} |~ \"(?i)(configured|created|deleted|applied revision|reconciliation failed|helm (upgrade|install|rollback) succeeded|upgrade succeeded|release.*upgraded|chart.*upgraded)\""
            }
          ],
          "options": {
            "showLabels": false,
            "showTime": true,
            "wrapLogMessage": true,
            "sortOrder": "Descending"
          }
        }
      ]
    }
